<!doctype html>
<html lang="en">

<head>
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
    integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
  <link rel="shortcut icon" href="favicon.png" type="image/x-icon" />
  <title>Putar Lagu (Server)</title>
  <style>
    .video-info {
      width: 100%;
      max-width: 700px;
    }

    img#thumbnail {
      border-radius: 50%;
      width: 100px;
      height: 100px;
      object-fit: cover;
    }

    .video-container {
      position: relative;
      padding-bottom: calc(100vh - 300px);
      padding-top: 30px;
      height: 0;
      max-height: 300px;
      overflow: hidden;
      width: 100%;
      max-width: 700px;
      border-radius: 20px;
    }

    .video-container iframe,
    .video-container object,
    .video-container embed {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <div class="w-100 d-flex flex-column align-items-center justify-content-center p-4" style="height: 100vh;">
    <div class="video-info d-flex flex-row align-items-center mb-3">
      <img id="thumbnail" src="" class="mr-3" />
      <div id="title" class="text-center my-2"></div>
    </div>
    <div class="video-container">
      <div id="player"></div>
    </div>
  </div>

  <script src="https://cdn.socket.io/4.3.2/socket.io.min.js"
    integrity="sha384-KAZ4DtjNhLChOB/hxXuKqhMLYvx3b5MlT55xPEiNmREKRzeEm+RVPlTnAn0ajQNs" crossorigin="anonymous">
  </script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <script>
    const socket = io('https://socket.yuk.party');
    //const socket = io('http://localhost:3000');
    var currentPlaying = null;
    var player;
    var videoId;

    swal("Klik tombol play untuk memulai pertama kali").then(() => {
      if (player) {
        player.playVideo();
      }
    });

    var tag = document.createElement('script');
    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '100%',
        width: '100%',
        videoId: videoId ? videoId : 'ts8i-6AtDfc',
        playerVars: {
          'playsinline': 1
        },
        events: {
          'onReady': onPlayerReady,
          'onStateChange': onPlayerStateChange
        }
      });

      var iframeWindow = player.getIframe().contentWindow;
      var lastTimeUpdate = 0;
      window.addEventListener("message", function (event) {
        if (event.source === iframeWindow) {
          var data = JSON.parse(event.data);
          if (
            data.event === "infoDelivery" &&
            data.info &&
            data.info.currentTime
          ) {
            var time = Math.floor(data.info.currentTime);

            if (time !== lastTimeUpdate) {
              lastTimeUpdate = time;
              const duration = player.getDuration();
              const currentTime = time;
              const text = humanDuration(Math.ceil(currentTime)) + ' / ' + humanDuration(Math.ceil(duration))
              socket.emit('putarlagu_updateState', {
                currentTime,
                duration,
                text
              });
            }
          }
        }
      });
    }

    function onPlayerReady(event) {
      event.target.playVideo();
    }

    function onPlayerStateChange(event) {
      const duration = player.getDuration();
      const currentTime = player.getCurrentTime();
      const text = humanDuration(Math.ceil(currentTime)) + ' / ' + humanDuration(Math.ceil(duration));

      if (event.data == YT.PlayerState.ENDED) {
        socket.emit('putarlagu_end');
      } else if (event.data == YT.PlayerState.PAUSED) {
        socket.emit('putarlagu_updateState', {
          currentTime,
          duration,
          text,
          isPaused: true
        });
      } else {
        socket.emit('putarlagu_updateState', {
          currentTime,
          duration,
          text,
          isPaused: false
        });
      }
    }

    function stopVideo() {
      player.stopVideo();
    }

    socket.emit('putarlagu_play');
    socket.on('putarlagu_play', function (data) {
      if (data) {
        currentPlaying = data;
        document.getElementById('thumbnail').src = data.thumbnailVideo;
        document.getElementById('title').innerHTML = data.title;
      }
      videoId = data.idVideo;
      player.loadVideoById(videoId, 0, "default");
    });

    function leftPad(str, num, chr) {
      str = String(str)
      num = num || 2
      chr = chr || '0'
      while (str.length < num) str = (chr + str)
      return str
    }

    function humanDuration(seconds) {
      const h = Math.floor(seconds / (60 * 60))
      const m = Math.floor(((seconds / 60) % 60))
      const s = seconds % 60

      if (h) {
        return (
          h + ':' + leftPad(m) + ':' + leftPad(s)
        )
      }

      return (
        m + ':' + leftPad(s)
      )
    }
  </script>
</body>

</html>